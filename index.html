<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture Psychology Engine | Debug Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #1a1a1a; --accent-pos: #d4a373; --accent-neg: #457b9d;
            --bg: #f8f8f8; --card-bg: #ffffff; --text: #222; --border: #eeeeee;
            --error: #e74c3c;
        }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        
        /* ステータス表示（デバッグ用） */
        .status-banner { 
            background: #fff; border: 1px solid var(--border); padding: 15px 20px; 
            margin-bottom: 20px; font-size: 0.85rem; display: flex; flex-direction: column; gap: 10px;
        }
        .status-msg { font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .error-msg { color: var(--error); border-top: 1px solid #eee; padding-top: 10px; display: none; }
        
        /* フォールバック用アップロードボタン（失敗時のみ表示） */
        #fallback-upload { display: none; margin-top: 10px; }
        .btn-sm { background: var(--primary); color: #fff; padding: 5px 15px; border: none; cursor: pointer; font-size: 0.75rem; }

        .config-panel { display: grid; grid-template-columns: 350px 1fr; gap: 30px; background: white; padding: 30px; border: 1px solid var(--border); margin-bottom: 40px; display: none; }
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .target-section { border-left: 1px solid var(--border); padding-left: 30px; }
        label { display: block; font-size: 0.65rem; font-weight: bold; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        select { width: 100%; padding: 10px; border: 1px solid var(--border); font-size: 0.85rem; background: #fff; border-radius: 0; }
        .target-select { font-size: 1.1rem; font-weight: 300; background: #fafafa; border-bottom: 2px solid var(--primary); }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; min-height: 400px; }
        .card { background: var(--card-bg); border: 1px solid var(--border); opacity: 0; transform: translateY(10px); transition: 0.4s; display: flex; flex-direction: column; }
        .card.is-visible { opacity: 1; transform: translateY(0); }
        .card-visual { width: 100%; height: 160px; background: #f0f0f0; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .card-visual img { width: 100%; height: 100%; object-fit: cover; }
        .card-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-label { font-size: 0.85rem; font-weight: 500; min-height: 3em; margin-bottom: 10px; }
        .r-value { font-size: 1.6rem; font-weight: 200; font-family: 'Georgia', serif; }
        .pos { color: var(--accent-pos); } .neg { color: var(--accent-neg); }
    </style>
</head>
<body>

<div class="container">
    <header style="border-bottom: 1px solid #000; margin-bottom: 20px; padding-bottom: 10px;">
        <h1 style="font-weight: 300; font-size: 1.2rem; letter-spacing: 0.1em;">Architecture Psychology Engine</h1>
    </header>

    <div class="status-banner">
        <div class="status-msg">
            <span id="spinner">⏳</span>
            <span id="load-text">CSVデータを自動ロード中...</span>
        </div>
        <div id="error-details" class="error-msg"></div>
        <div id="fallback-upload">
            <p style="margin: 0 0 10px 0; font-size: 0.8rem;">自動ロードに失敗しました。ファイル名が <b>data.csv</b> であるか確認するか、手動で選択してください：</p>
            <input type="file" id="manual-file" accept=".csv">
        </div>
    </div>

    <div class="config-panel" id="main-ui">
        <div class="filter-grid" id="filters"></div>
        <div class="target-section">
            <label>Target Psychology</label>
            <select id="target-psychology" class="target-select" onchange="runSimulation()"></select>
        </div>
    </div>

    <div id="results-area" style="display:none;">
        <div id="n-display" style="font-size: 0.8rem; margin-bottom: 15px; font-weight: bold;"></div>
        <div class="card-grid" id="card-grid"></div>
    </div>
</div>

<script>
let masterData = [];
let columns = { attr: [], psych: [], arch: [] };

const imageUrlMap = {
  "心地のよい居場所がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_a99830ec-ad0c-4b83-af07-9712e7573259.png",
  "快適な室温を保つことができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_db45356c-6acc-408f-b887-89d8c508dc7d.png",
  "快適に感じる広さがある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_63c604f4-dbd1-430f-9818-0f1c12e38b32.png",
  "快適に感じる天井の高さがある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_41032e89-f4e9-4eeb-a7de-bb8e03c7b0a8.png",
  "窓からの日当たりが気持ちよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_2d3a9102-6587-42e7-be71-9e80d3f72fe8.png",
  "窓からの風通しが気持ちよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_20538102-f7e0-40d3-92c7-87e4047d3c60.png",
  "窓からの眺めがよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_b1bd8cce-0e01-40a4-bd59-3ff40188a9b1.png",
  "快適なテラス（縁側）がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_36a94638-f1f3-4984-ab65-87ff35de73c0.png",
  "雰囲気のよい照明がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_70ba8f61-0566-4f80-9bbf-43d8656b4b94.png",
  "見通しがよく、空間全体を見渡せる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_9b611a5c-b548-486d-819a-771f25882a63.png",
  "開放感があり気持ちよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_bd2f4281-0875-4b85-9643-a9d4152e0819.png",
  "よい香りがしていて快適である": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_ad6b2381-7355-47fd-8644-8c22d964a9ab.png",
  "身近に自然を感じることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_acdf1c17-5336-4043-9fed-0b97ee9b4ce3.png",
  "建材に自然素材（木の板など）が多く用いられている": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_fe502da2-d080-47bd-a108-69e29d197a0d.png",
  "みんなで集まる快適な場所がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_8c0aa027-950e-4850-b84d-1bd434b92b9b.png",
  "快適に食事を摂ることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_d37c5903-4bf2-42ef-ae9d-17b19014e261.png",
  "快適に睡眠（仮眠）を摂ることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_b006e411-9caf-4959-8793-3f4cc67198d7.png",
  "快適なトイレがある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_fc0bc044-648b-402a-9e11-e770b777a83d.png",
  "清掃などによって清潔な状態に保たれている": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_93739dfa-0c0f-4cc7-8faf-8d3abc77f95b.png",
  "浴室（シャワー室）、洗面室で自分自身を清潔に保つことができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_350616b6-9467-4d7a-85d7-f01037f37435.png",
  "家具のレイアウト等を自由に変えることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_c4a5ba4c-2a56-4d0b-b007-6b680556f17b.png",
  "建具を開閉すること等により空間を自由に使うことができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_39d07e65-860a-45be-ab64-b8ae03b0c418.png",
  "好みの壁紙に変えたり、カスタマイズすることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_deb6fa9f-7a66-42e1-a815-d8d9c7d50b55.png",
  "自分自身の個性を表現することができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_444d3d96-2ff9-4331-883d-a59029fe959a.png",
  "好きな時に好きなところへ移動ができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_c5a3d3c1-be55-4186-b9ad-5bcd229169db.png",
  "自由に過ごし方を決めることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_1bf719ed-086d-406a-90a9-02ec92e1cf5e.png",
  "用途がない空間に心地よさを感じる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_28dbd1f9-6f98-4244-9e0d-bfc763d0f9e5.png",
  "芸術を楽しむことができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_d49a2ee1-cb28-4ae9-b2b4-4f54a2426538.png",
  "自分以外の誰かとコミュニケーションを取りやすい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_3a37db49-ad55-457d-9de6-fbbdd2487b29.png",
  "自分以外の誰かと適度な距離感を保てて快適である": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_31373c16-7990-412d-8f95-0eb99bc15222.png",
  "自分以外の人の視線が気にならない": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_b48f351d-4555-4258-8983-2cdc80bd15c1.png",
  "気を使わずに行動できる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_2843b486-1c82-49bc-b19b-4d5afbd74185.png",
  "快適に使用できる家具がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_606a2196-b901-4873-a412-7bd5694ee390.png",
  "芸術作品が身近にある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_7faad49e-9174-4288-8602-45afb2a4db51.png",
  "植物（観葉植物、生花）が置かれている": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_66c2c41b-a00b-4a8c-9cc9-237d0b5fdfef.png"
};

function normalize(s) { return s ? s.replace(/[\s\n\r]/g, "") : ""; }
const normImageMap = {};
for (let k in imageUrlMap) { normImageMap[normalize(k)] = imageUrlMap[k]; }

// 起動時の処理
window.onload = function() {
    const csvPath = './data.csv'; // パスを明示
    console.log("Attempting to load:", csvPath);
    
    fetch(csvPath)
    .then(res => {
        if(!res.ok) throw new Error(`HTTP Error ${res.status}: ${res.statusText}`);
        return res.text();
    })
    .then(csv => parseCSV(csv))
    .catch(err => {
        showError(`読み込みに失敗しました: ${err.message}`);
    });
};

// 手動アップロードの監視
document.getElementById('manual-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) { parseCSV(evt.target.result); };
    reader.readAsText(file);
});

function parseCSV(csv) {
    Papa.parse(csv, {
        header: false, dynamicTyping: true, skipEmptyLines: true,
        complete: function(results) {
            const raw = results.data;
            if(raw.length < 3) {
                showError("CSVの行数が足りません。3行目からデータが始まっているか確認してください。");
                return;
            }
            masterData = raw.slice(2);
            columns.attr = [9, 2, 3, 4, 5, 6, 7, 8].map(i => ({ idx: i, name: raw[0][i] }));
            columns.psych = []; for(let i=10; i<=52; i++) columns.psych.push({ idx: i, label: raw[1][i] || raw[0][i] });
            columns.arch = []; for(let i=53; i<=98; i++) columns.arch.push({ idx: i, label: raw[1][i] || raw[0][i] });
            
            initUI();
        },
        error: function(err) { showError("CSV解析エラー: " + err.message); }
    });
}

function showError(msg) {
    document.getElementById('spinner').innerText = "❌";
    document.getElementById('load-text').innerText = "ロード失敗";
    const details = document.getElementById('error-details');
    details.innerText = msg;
    details.style.display = 'block';
    document.getElementById('fallback-upload').style.display = 'block';
}

function initUI() {
    document.getElementById('spinner').innerText = "✅";
    document.getElementById('load-text').innerText = "データを同期しました";
    document.getElementById('main-ui').style.display = 'grid';
    document.getElementById('results-area').style.display = 'block';
    
    const filterBox = document.getElementById('filters');
    filterBox.innerHTML = '';
    columns.attr.forEach(col => {
        const unique = [...new Set(masterData.map(d => d[col.idx]))].filter(v => v != null).sort();
        const div = document.createElement('div');
        div.innerHTML = `<label>${col.name}</label><select class="filter-select" data-idx="${col.idx}" onchange="runSimulation()"><option value="all">ALL</option>${unique.map(v => `<option value="${v}">${v}</option>`).join('')}</select>`;
        filterBox.appendChild(div);
    });
    
    document.getElementById('target-psychology').innerHTML = columns.psych.map(p => `<option value="${p.idx}">${p.label}</option>`).join('');
    runSimulation();
}

function calculateCorrelation(data, x, y) {
    const subset = data.filter(d => typeof d[x] === 'number' && typeof d[y] === 'number');
    const n = subset.length; if(n < 2) return 0;
    let sX=0, sY=0, sXY=0, sX2=0, sY2=0;
    for(let i=0; i<n; i++){
        let vX=subset[i][x], vY=subset[i][y];
        sX+=vX; sY+=vY; sXY+=vX*vY; sX2+=vX*vX; sY2+=vY*vY;
    }
    const num = (n*sXY)-(sX*sY), den = Math.sqrt(((n*sX2)-(sX*sX))*((n*sY2)-(sY*sY)));
    return den===0 ? 0 : num/den;
}

function runSimulation() {
    const selects = document.querySelectorAll('.filter-select');
    let filtered = masterData;
    selects.forEach(s => { if(s.value !== 'all') { const v = isNaN(s.value) ? s.value : Number(s.value); filtered = filtered.filter(d => d[s.dataset.idx] === v); }});
    
    const targetIdx = parseInt(document.getElementById('target-psychology').value);
    const results = columns.arch.map(a => ({ label: a.label, r: calculateCorrelation(filtered, targetIdx, a.idx) })).sort((a,b)=>b.r - a.r);
    
    document.getElementById('n-display').innerText = `SAMPLE SIZE: N = ${filtered.length}`;
    const grid = document.getElementById('card-grid');
    grid.innerHTML = '';
    
    results.forEach((res, i) => {
        if(Math.abs(res.r) < 0.01) return;
        const img = normImageMap[normalize(res.label)];
        const visual = img ? `<img src="${img}" loading="lazy">` : `<div style="color:#ccc"><i data-lucide="component" stroke-width="1" size="32"></i></div>`;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<div class="card-visual">${visual}</div><div class="card-content"><div class="card-label">${res.label}</div><div class="card-footer"><span class="r-value ${res.r>=0?'pos':'neg'}">${res.r.toFixed(3)}</span><span class="r-unit">Correlation</span></div></div>`;
        grid.appendChild(card);
        setTimeout(() => card.classList.add('is-visible'), i * 40);
    });
    lucide.createIcons();
}
</script>
</body>
</html>
