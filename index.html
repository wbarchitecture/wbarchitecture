<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ウェルビーイングと空間要素</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #1a1a1a; --accent-pos: #d4a373; --accent-neg: #457b9d;
            --bg: #f8f8f8; --card-bg: #ffffff; --text: #222; --border: #eeeeee;
        }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Sans", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        
        header { 
            border-bottom: 1px solid var(--primary); 
            margin-bottom: 30px; 
            padding-bottom: 20px; 
            display: flex; 
            flex-direction: column; 
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .nav-link { 
            font-size: 0.8rem; 
            text-decoration: none; 
            color: var(--primary); 
            border: 1px solid var(--primary); 
            padding: 5px 15px; 
            letter-spacing: 0.1em; 
            transition: 0.3s;
            cursor: pointer;
        }
        .nav-link:hover { background: var(--primary); color: #fff; }

        .description-text { 
            font-size: 0.85rem; 
            color: #555; 
            line-height: 1.8; 
            margin-top: 20px; 
            max-width: 1100px; 
            white-space: pre-wrap; 
        }

        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(255,255,255,0.95); overflow-y: auto;
        }
        .modal-content {
            max-width: 800px; margin: 60px auto; padding: 40px;
            animation: modalFade 0.5s ease;
        }
        @keyframes modalFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .close-btn { float: right; font-size: 1.5rem; cursor: pointer; font-weight: 100; }
        .profile-name { font-size: 1.8rem; font-weight: 300; letter-spacing: 0.2em; margin-bottom: 5px; }
        .profile-title { font-size: 0.9rem; color: var(--accent-pos); margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .profile-job { font-size: 0.85rem; line-height: 2; margin-bottom: 30px; color: #444; }
        .profile-body { font-size: 0.9rem; line-height: 2; color: #333; text-align: justify; }

        .status-bar { background: #fff; padding: 10px 20px; border: 1px solid var(--border); margin-bottom: 20px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; }

        .config-panel { display: grid; grid-template-columns: 350px 1fr; gap: 40px; background: white; padding: 30px; border: 1px solid var(--border); margin-bottom: 40px; }
        .filter-panel { border-left: 1px solid var(--border); padding-left: 40px; }
        .filter-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        label { display: block; font-size: 0.65rem; font-weight: bold; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        select { width: 100%; padding: 10px; border: 1px solid var(--border); font-size: 0.85rem; background: #fff; border-radius: 0; }
        .target-select { font-size: 1.1rem; font-weight: 300; background: #fafafa; border-bottom: 2px solid var(--primary); }

        .comparison-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .column-header { text-align: center; margin-bottom: 20px; padding: 10px; background: var(--primary); color: white; letter-spacing: 0.2em; font-weight: 200; text-transform: uppercase; font-size: 0.9rem; }
        .n-badge { font-size: 0.7rem; color: #aaa; margin-top: 5px; }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; min-height: 400px; }
        .card { 
            background: var(--card-bg); border: 1px solid var(--border); 
            display: flex; flex-direction: column; opacity: 0; transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .card.is-visible { opacity: 1; transform: translateY(0); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.08); border-color: var(--primary); }
        
        .card-visual { width: 100%; height: 140px; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center; }
        .card-visual img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-label { font-size: 0.8rem; font-weight: 500; min-height: 3.2em; margin-bottom: 10px; line-height: 1.5; }
        .card-footer { display: flex; justify-content: space-between; align-items: baseline; }
        .r-value { font-size: 1.6rem; font-weight: 200; font-family: 'Georgia', serif; }
        .pos { color: var(--accent-pos); } .neg { color: var(--accent-neg); }
        .r-unit { font-size: 0.5rem; color: #aaa; margin-left: 4px; }

        @media (max-width: 1100px) {
            .comparison-layout, .config-panel { grid-template-columns: 1fr; }
            .filter-panel { border-left: none; padding-left: 0; border-top: 1px solid var(--border); padding-top: 20px; }
        }
    </style>
</head>
<body>

<div id="aboutModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAbout()">&times; CLOSE</span>
        <div class="profile-name">岡 昇平</div>
        <div class="profile-title">一級建築士</div>
        <div class="profile-job">
            設計事務所岡昇平 代表、仏生山温泉 番台、仏生山まちぐるみ旅館 代表、スペースシンタックス・ジャパン 取締役<br>
            慶應義塾大学大学院 システムデザイン・マネジメント研究科 特任講師<br>
            岡山県立大学 デザイン学部 建築学科 非常勤講師
        </div>
        <div class="profile-body">
            建築設計、温泉のこと、まちづくり、を本業としている。<br><br>
            建築設計では、新しい価値と魅力づくりをベースとしたうえで、居心地の良さを大切にした住宅、オフィス、商業施設等の設計を行う。自由度が小さく、人の側に主体性がない空間を「やらされ建築」と呼び、心的要因に由来する居心地の良さや、人と人との関係性をウェルビーイングの視点から研究開発を行っている。<br><br>
            温泉のことは、日帰り温浴施設である仏生山温泉を2005年に立ち上げ、計画、設計、運営までを担う。仏生山温泉では、すべての浴槽で源泉掛け流しを楽しめるようになっている。また、湯船で読書ができるなど長時間滞在を推奨し、温泉とともに過ごす前後の時間も大切にしている。トリップアドバイザーのランキングでは「旅好きが選ぶ！日本人に人気の日帰り温泉&スパ」2019年、2020年にそれぞれ全国1位に選ばれている。そのほか、長門湯本温泉 恩湯、湯河原惣湯 惣湯テラス、榊原温泉 禊湯など、全国各地で温浴施設のディレクション、設計、運営、コンサルタントを行う。<br><br>
            まちづくりでは、まち全体を旅館に見立てる「仏生山まちぐるみ旅館」を2012年から進めている。コンセプトの「にやにやしながら暮らす」は主観的ウェルビーイングを高めるまちづくりである。地域の共有価値として位置付けている「お店」が10数年で30店程度増加している。共著書に「地方で建築を仕事にする」、「プロジェクト図解 地域の場を設計して、運営する」がある。
        </div>
    </div>
</div>

<div class="container">
    <header>
        <div class="header-top">
            <h1 style="font-weight: 300; letter-spacing: 0.1em; margin:0;">ウェルビーイングと空間要素</h1>
            <a class="nav-link" onclick="openAbout()">ABOUT US</a>
        </div>
        <div class="title-row" style="margin-top:20px;">
            <div id="total-n" style="font-size: 0.8rem; font-weight: bold; letter-spacing: 0.1em;">TOTAL N = 0</div>
        </div>
        <p class="description-text">本サイトは、「主観的ウェルビーイング」と「空間の構成要素」の相関係数をもとに、影響の大きい要素の把握や、要素同士の比較ができる可視化ツールです。
新しい空間デザインの検討や、既存空間の診断・リノベーションのサポートとしての活用を目的としています。
なお、掲載しているデータは相関に基づくものであり、因果関係を示すものではありません。
設計や意思決定の際は、補助的な参考情報として使用してください。</p>
    </header>

    <div class="status-bar" id="status-bar">
        <span id="data-status">CSVをロード中...</span>
        <span style="color: var(--accent-pos);">data.csv</span>
    </div>

    <div class="config-panel" id="main-ui" style="display:none;">
        <div class="target-section">
            <label>Target Psychology</label>
            <select id="target-psychology" class="target-select" onchange="runSimulation()"></select>
        </div>
        <div class="filter-panel">
            <label>Attributes Filters</label>
            <div class="filter-grid" id="filters"></div>
        </div>
    </div>

    <div id="results-area" style="display:none;">
        <div class="comparison-layout">
            <div class="column">
                <div class="column-header">Residential <div class="n-badge" id="n-housing">N=0</div></div>
                <div class="card-grid" id="grid-housing"></div>
            </div>
            <div class="column">
                <div class="column-header">Office <div class="n-badge" id="n-office">N=0</div></div>
                <div class="card-grid" id="grid-office"></div>
            </div>
        </div>
    </div>
</div>

<script>
let masterData = [];
let columns = { attr: [], psych: [], arch: [] };

function openAbout() { document.getElementById('aboutModal').style.display = "block"; }
function closeAbout() { document.getElementById('aboutModal').style.display = "none"; }
window.onclick = function(event) { if (event.target == document.getElementById('aboutModal')) closeAbout(); }

const imageUrlMap = {
  "心地のよい居場所がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_a99830ec-ad0c-4b83-af07-9712e7573259.png",
  "快適な室温を保つことができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_db45356c-6acc-408f-b887-89d8c508dc7d.png",
  "快適に感じる広さがある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_63c604f4-dbd1-430f-9818-0f1c12e38b32.png",
  "快適に感じる天井の高さがある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_41032e89-f4e9-4eeb-a7de-bb8e03c7b0a8.png",
  "窓からの日当たりが気持ちよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_2d3a9102-6587-42e7-be71-9e80d3f72fe8.png",
  "窓からの風通しが気持ちよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_20538102-f7e0-40d3-92c7-87e4047d3c60.png",
  "窓からの眺めがよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_b1bd8cce-0e01-40a4-bd59-3ff40188a9b1.png",
  "快適なテラス（縁側）がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_36a94638-f1f3-4984-ab65-87ff35de73c0.png",
  "雰囲気のよい照明がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_70ba8f61-0566-4f80-9bbf-43d8656b4b94.png",
  "見通しがよく、空間全体を見渡せる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_9b611a5c-b548-486d-819a-771f25882a63.png",
  "開放感があり気持ちよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_bd2f4281-0875-4b85-9643-a9d4152e0819.png",
  "よい香りがしていて快適である": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_ad6b2381-7355-47fd-8644-8c22d964a9ab.png",
  "身近に自然を感じることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_acdf1c17-5336-4043-9fed-0b97ee9b4ce3.png",
  "建材に自然素材（木の板など）が多く用いられている": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_fe502da2-d080-47bd-a108-69e29d197a0d.png",
  "みんなで集まる快適な場所がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_8c0aa027-950e-4850-b84d-1bd434b92b9b.png",
  "快適に食事を摂ることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_d37c5903-4bf2-42ef-ae9d-17b19014e261.png",
  "快適に睡眠（仮眠）を摂ることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x142_webp_b006e411-9caf-4959-8793-3f4cc67198d7.png",
  "快適なトイレがある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_fc0bc044-648b-402a-9e11-e770b777a83d.png",
  "清掃などによって清潔な状態に保たれている": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_93739dfa-0c0f-4cc7-8faf-8d3abc77f95b.png",
  "浴室（シャワー室）、洗面室で自分自身を清潔に保つことができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_350616b6-9467-4d7a-85d7-f01037f37435.png",
  "家具のレイアウト等を自由に変えることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_c4a5ba4c-2a56-4d0b-b007-6b680556f17b.png",
  "建具を開閉すること等により空間を自由に使うことができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_39d07e65-860a-45be-ab64-b8ae03b0c418.png",
  "好みの壁紙に変えたり、カスタマイズすることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_deb6fa9f-7a66-42e1-a815-d8d9c7d50b55.png",
  "自分自身の個性を表現することができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_444d3d96-2ff9-4331-883d-a59029fe959a.png",
  "好きな時に好きなところへ移動ができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_c5a3d3c1-be55-4186-b9ad-5bcd229169db.png",
  "自由に過ごし方を決めることができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_1bf719ed-086d-406a-90a9-02ec92e1cf5e.png",
  "用途がない空間に心地よさを感じる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_28dbd1f9-6f98-4244-9e0d-bfc763d0f9e5.png",
  "芸術を楽しむことができる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_d49a2ee1-cb28-4ae9-b2b4-4f54a2426538.png",
  "自分以外の誰かとコミュニケーションを取りやすい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_3a37db49-ad55-457d-9de6-fbbdd2487b29.png",
  "自分以外の誰かと適度な距離感を保てて快適である": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_31373c16-7990-412d-8f95-0eb99bc15222.png",
  "自分以外の人の視線が気にならない": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_b48f351d-4555-4258-8983-2cdc80bd15c1.png",
  "気を使わずに行動できる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_2843b486-1c82-49bc-b19b-4d5afbd74185.png",
  "快適に使用できる家具がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_606a2196-b901-4873-a412-7bd5694ee390.png",
  "芸術作品が身近にある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_7faad49e-9174-4288-8602-45afb2a4db51.png",
  "植物（観葉植物、生花）が置かれている": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-266x141_webp_66c2c41b-a00b-4a8c-9cc9-237d0b5fdfef.png"
};

function superNormalize(s) { return s ? String(s).replace(/[\s\n\r（）\(\)]/g, "") : ""; }
const normMap = {}; for (let k in imageUrlMap) { normMap[superNormalize(k)] = imageUrlMap[k]; }

function getIconName(label) {
    const l = superNormalize(label);
    if (l.includes('安心')) return 'shield';
    if (l.includes('音')) return 'volume-2';
    if (l.includes('視線')) return 'eye-off';
    return 'component';
}

window.onload = function () {
    Papa.parse("data.csv", {
        download: true, header: false, dynamicTyping: true, skipEmptyLines: true,
        complete: function (results) {
            const raw = results.data;
            masterData = raw.slice(2);
            // 属性を「性別(2)」「年代(3)」「居住地方(4)」に限定
            columns.attr = [2, 3, 4].map(idx => ({ idx, name: raw[0][idx] }));
            columns.psych = []; for (let i = 10; i <= 52; i++) columns.psych.push({ idx: i, label: raw[1][i] || raw[0][i] });
            columns.arch = []; for (let i = 53; i <= 98; i++) columns.arch.push({ idx: i, label: raw[1][i] || raw[0][i] });

            setupFilters();
            setupPsychList();
            document.getElementById('data-status').innerText = "SUCCESS: データ同期完了";
            document.getElementById('main-ui').style.display = 'grid';
            document.getElementById('results-area').style.display = 'block';
            runSimulation();
        }
    });
};

function setupFilters() {
    const container = document.getElementById('filters'); container.innerHTML = '';
    columns.attr.forEach(col => {
        const uniqueValues = [...new Set(masterData.map(d => d[col.idx]))].filter(v => v != null).sort();
        const div = document.createElement('div');
        div.innerHTML = `<label>${col.name}</label><select class="filter-select" data-idx="${col.idx}" onchange="runSimulation()"><option value="all">ALL</option>${uniqueValues.map(v => `<option value="${v}">${v}</option>`).join('')}</select>`;
        container.appendChild(div);
    });
}

function setupPsychList() {
    document.getElementById('target-psychology').innerHTML = columns.psych.map(p => `<option value="${p.idx}">${p.label}</option>`).join('');
}

function calculateCorrelation(data, idxX, idxY) {
    const subset = data.filter(d => typeof d[idxX] === 'number' && typeof d[idxY] === 'number');
    const n = subset.length; if (n < 2) return 0;
    let sX=0, sY=0, sXY=0, sX2=0, sY2=0;
    for(let i=0; i<n; i++) {
        let x=subset[i][idxX], y=subset[i][idxY];
        sX+=x; sY+=y; sXY+=x*y; sX2+=x*x; sY2+=y*y;
    }
    const num = (n*sXY)-(sX*sY), den = Math.sqrt(((n*sX2)-(sX*sX))*((n*sY2)-(sY*sY)));
    return den===0 ? 0 : num / den;
}

function renderGrid(gridId, nId, data, targetIdx) {
    const grid = document.getElementById(gridId);
    const nDisplay = document.getElementById(nId);
    const results = columns.arch.map(a => ({ label: a.label, r: calculateCorrelation(data, targetIdx, a.idx) })).sort((a, b) => b.r - a.r);

    nDisplay.innerText = `N = ${data.length}`;
    grid.style.opacity = 0;
    
    setTimeout(() => {
        grid.innerHTML = '';
        results.forEach((res, i) => {
            if (Math.abs(res.r) < 0.01) return;
            const img = normMap[superNormalize(res.label)];
            const visual = img ? `<img src="${img}" loading="lazy">` : `<div class="icon-placeholder"><i data-lucide="${getIconName(res.label)}" stroke-width="1"></i></div>`;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="card-visual">${visual}</div><div class="card-content"><div class="card-label">${res.label}</div><div class="card-footer"><span class="r-value ${res.r>=0?'pos':'neg'}">${res.r.toFixed(2)}</span><span class="r-unit">Correlation</span></div></div>`;
            grid.appendChild(card);
            setTimeout(() => card.classList.add('is-visible'), i * 30);
        });
        lucide.createIcons();
        grid.style.opacity = 1;
    }, 200);
}

function runSimulation() {
    const selects = document.querySelectorAll('.filter-select');
    let filteredTotal = masterData;
    selects.forEach(s => {
        if (s.value !== 'all') {
            const val = isNaN(s.value) ? s.value : Number(s.value);
            filteredTotal = filteredTotal.filter(d => d[s.dataset.idx] === val);
        }
    });

    document.getElementById('total-n').innerText = `TOTAL N = ${filteredTotal.length}`;
    const targetIdx = parseInt(document.getElementById('target-psychology').value);

    const housingData = filteredTotal.filter(d => superNormalize(String(d[9])) === "住宅");
    const officeData = filteredTotal.filter(d => superNormalize(String(d[9])) === "オフィス");

    renderGrid('grid-housing', 'n-housing', housingData, targetIdx);
    renderGrid('grid-office', 'n-office', officeData, targetIdx);
}
</script>
</body>
</html>
